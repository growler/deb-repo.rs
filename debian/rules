#!/usr/bin/make -f

export DEB_BUILD_MAINT_OPTIONS = hardening=+all
export CARGO_HOME := $(CURDIR)/target/cargo-home
export CARGO_TARGET_DIR := $(CURDIR)/target
MANPAGE_MD := docs/rdebootstrap.1.md
MANPAGE := target/man/rdebootstrap.1

%:
	dh $@

override_dh_auto_configure:
	mkdir -p $(CARGO_HOME)
	cargo fetch --locked

override_dh_auto_build:
	cargo build -p rdebootstrap --release --locked --bin rdebootstrap
	cargo xtask build-man

override_dh_auto_test:
ifeq (,$(filter nocheck,$(DEB_BUILD_OPTIONS)))
	cargo test --locked --workspace --all-targets -- --nocapture
endif

override_dh_auto_install:
	install -Dm755 target/release/rdebootstrap \
		$(CURDIR)/debian/rdebootstrap/usr/bin/rdebootstrap
	install -Dm644 debian/usr.bin.rdebootstrap \
		$(CURDIR)/debian/rdebootstrap/etc/apparmor.d/usr.bin.rdebootstrap
	bash -c 'install -Dm644 -t $(CURDIR)/debian/rdebootstrap/usr/share/man/man1 target/man/rdebootstrap*.1'

override_dh_auto_clean:
	-cargo clean -r
	rm -rf target/man
